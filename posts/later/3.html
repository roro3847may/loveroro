<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>+ #3</title>
  <script type="module" src="../../js/firebase.js"></script>
  <link rel="stylesheet" href="../../css/style.css?v=3">
</head>
<body class="later">
  <header id="site-header"></header>
  <script>
    fetch("../../header.html")
      .then(r => r.text())
      .then(h => {{
        const headerEl = document.getElementById("site-header");
        headerEl.innerHTML = h;
        headerEl.querySelectorAll("script").forEach((oldScript) => {{
          const newScript = document.createElement("script");
          if (oldScript.src) newScript.src = oldScript.src;
          else newScript.textContent = oldScript.textContent;
          document.body.appendChild(newScript);
        }});
      }});
  </script>

  <div class="container">
    <h1>+ #3</h1>
    <p>
생각을 편하게 하고 마음을 정리하니 우울이 떠나가서~ +20d
    </p>

    <p class="adjust-token">+20d</p>
    <hr>
    <h3>댓글</h3>
    <div id="comments"></div>
    <input type="text" id="commentInput" placeholder="‘사랑해’만 입력할 수 있습니다." maxlength="3">
    <button id="commentButton">전송</button>
  </div>

  <script type="module">
  import { db, ref, push, get, set, onValue } from "../../js/firebase.js";

  const commentsDiv = document.getElementById("comments");
  const input = document.getElementById("commentInput");
  const button = document.getElementById("commentButton");

  const pathParts = location.pathname.split("/");
  const postId = pathParts.slice(-1)[0].replace(".html", "");
  const category = pathParts.includes("later") ? "later" : "sooner";
  const commentsRef = ref(db, `comments/${category}-${postId}`);

  function renderComments(data) {
    commentsDiv.innerHTML = "";
    let idx = 1;
    if (data) {
      Object.values(data).forEach((text) => {
        const p = document.createElement("p");
        p.innerText = `익명${idx++}: ${text}`;
        commentsDiv.appendChild(p);
      });
    }
  }

  onValue(commentsRef, (snapshot) => {
    renderComments(snapshot.val());
  });

  button.addEventListener("click", () => {
    const val = input.value.trim();
    if (val !== "사랑해") {
      alert("‘사랑해’만 입력할 수 있습니다.");
      return;
    }
    push(commentsRef, val);
    const countRef = ref(db, "loveCount");
    get(countRef).then((snap) => {
      const newCount = (snap.val() || 0) + 1;
      set(countRef, newCount);
    });
    input.value = "";
  });
  </script>
</body>
</html>

